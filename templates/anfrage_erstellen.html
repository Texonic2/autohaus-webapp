{% extends "base.html" %}

{% block title %}ðŸ“„ Anfrage erstellen{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/anfrage_erstellen.css') }}">

<div class="anfrage-wrapper">
    <h2>ðŸ“„ Finanzierungs- oder Barkaufanfrage</h2>
    <form method="POST">

        <!-- Fahrzeugauswahl -->
        <label class="anfrage-label">Fahrzeug auswÃ¤hlen:</label>
        <select name="auto_id" class="anfrage-input" id="auto-select" required>
            <option value="">-- Bitte wÃ¤hlen --</option>
            {% for auto in autos %}
                <option value="{{ auto.autoid }}"
                        data-preis="{{ auto.preis }}"
                        {% if auto_id == auto.autoid or request.form.auto_id == auto.autoid|string %}selected{% endif %}>
                    {{ auto.marke }} {{ auto.modell }}
                </option>
            {% endfor %}
        </select>

        <!-- Dynamische Preis-Anzeige -->
        <div id="fahrzeug-preis" class="anfrage-info" style="margin-top: 6px; font-weight: bold;"></div>

        <!-- Kaufart-Auswahl -->
        <label class="anfrage-label">Kaufart:</label>
        <select name="kaufart" class="anfrage-input" id="kaufart-select" required>
            <option value="">-- Bitte wÃ¤hlen --</option>
            <option value="Barkauf" {% if kaufart == 'Barkauf' %}selected{% endif %}>Barkauf</option>
            <option value="Finanzierungsanfrage" {% if kaufart == 'Finanzierungsanfrage' %}selected{% endif %}>Finanzierung</option>
        </select>

        <!-- Finanzierungsfelder -->
        <div id="finanzierung-felder" style="display: none; margin-top: 10px;">
            <label class="anfrage-label">Finanzierungsdauer (Monate):</label>
            <input type="number" name="laufzeit" min="1" class="anfrage-input"
                   value="{{ laufzeit or request.form.laufzeit or '' }}">

            <label class="anfrage-label">Startzahlung (â‚¬):</label>
            <input type="number" name="anzahlung" step="0.01" class="anfrage-input"
                   value="{{ anzahlung or request.form.anzahlung or '' }}">

            <label class="anfrage-label">Endzahlung (Schlussrate) (â‚¬):</label>
            <input type="number" name="schlussrate" step="0.01" class="anfrage-input"
                   value="{{ schlussrate or request.form.schlussrate or '' }}">
        </div>

        {% if rate is not none %}
            <div class="anfrage-info">
                Monatliche Rate: {{ rate }} â‚¬
            </div>
        {% endif %}

        <!-- Kunden-E-Mail -->
        <label class="anfrage-label">Kunden-E-Mail-Adresse:</label>
        <input type="email" name="email" class="anfrage-input"
               value="{{ request.form.email or '' }}" required>

        <!-- Termin -->
        <label class="anfrage-label">Terminwunsch (Datum & Uhrzeit):</label>
        <input type="datetime-local" name="terminwunsch" class="anfrage-input"
               value="{{ request.form.terminwunsch or '' }}" required>

        {% if fehler %}
            <p class="anfrage-error">{{ fehler }}</p>
        {% endif %}

        <button type="submit" class="anfrage-button">
            {% if rate and preis %}
                âœ… Anfrage abschicken
            {% else %}
                Weiter
            {% endif %}
        </button>
    </form>
</div>


<script>
  function toggleFinanzierung() {
    const auswahl = document.getElementById("kaufart-select").value;
    const felder = document.getElementById("finanzierung-felder");
    felder.style.display = auswahl === "Finanzierungsanfrage" ? "block" : "none";
  }

  function zeigePreis() {
    const select = document.getElementById("auto-select");
    const preisDiv = document.getElementById("fahrzeug-preis");
    const selectedOption = select.options[select.selectedIndex];

    const preis = selectedOption.getAttribute("data-preis");
    if (preis) {
      preisDiv.textContent = `ðŸ’° Fahrzeugpreis: ${parseFloat(preis).toLocaleString('de-DE')} â‚¬`;
    } else {
      preisDiv.textContent = "";
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    toggleFinanzierung();
    zeigePreis();
    document.getElementById("kaufart-select").addEventListener("change", toggleFinanzierung);
    document.getElementById("auto-select").addEventListener("change", zeigePreis);
  });
</script>
{% endblock %}
